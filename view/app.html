<!-- AxTi APP-->
<!-- Socket.io based real-time chat with message history-->
<!-- Cookies (Laura) -->
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
    <script src="/socket.io/socket.io.js"></script>
    <title>AxTi App</title>
    <style>
      body, html{width:100%;height: 100%;overflow: hidden;background-color:#333 !important}.navbar{height: 5vh !important;background-color:#424242 !important}.navmenu_left{background-color:#424242!important;width:20vw !important;height: 95vh !important}.userlist{overflow: auto;height: 100%}.user_card{background-color:#424242!important;border:0;color:#FFF}.avatar_image{height:3em;border-radius:3em}.avatar_text{font-size:1.2em}.footer{position: fixed;float:right;bottom: 0;width:81vw;background-color: #424242;color: white;text-align: center;padding:1em;margin-left:-1em}.message_container, .row, .usertext{overflow: auto;height: 100%}.message_container{padding-bottom:9em}.message_card{background-color:#333!important;border:0;color:#FFF;margin-bottom: -2em}hr{display: block;height: 1px;border: 0;border-top: 1px solid #fff;margin: 1em 0;padding: 0}
    </style>
  </head>
  <body onload="checkCookie()">
    <nav class="navbar navbar-expand-lg navbar-dark">
      <a style="margin-top:1em" class="navbar-brand" href="#">
      Ax<span style="color:rgb(133, 39, 177)">Ti</span></a>
      <ul class="navbar-nav mr-auto">
      </ul>
      <span class="navbar-text">
      <span id="pseudo_text"></span>
      <a href=# onclick="logout()">
      Se déconnecter
      </a>
      </span>
   </nav>
   <div class="row">
      <div class=" navmenu_left">
         <hr style="width:70%;margin-left:auto;margin-right:auto;">
         <div class="userlist">
         </div>
      </div>
      <div class="col usertext">
         <div class="message_container">
         </div>
         <div class="footer">
            <input type="text" autocomplete="off" onkeypress="checkenter(event)" placeholder="Envoyer un message &#xf1d8;" style="font-family:Arial, FontAwesome" id="m" class="form-control sendmessage">
         </div>
      </div>
   </div>
   <div class="modal fade" id="loginmodal"  data-backdrop="static" tabindex="-1"  aria-hidden="true">
      <div class="modal-dialog">
         <div class="modal-content">
            <div class="modal-header" style="text-align:center">
               <h5 class="modal-title" >AxTi</h5>
            </div>
            <div class="modal-body">
               <p>Bienvenue dans AxTi !</p>
               <p>Pour utiliser l'application veuillez entrer un pseudo et veuillez selectionner une image de profil</p>
               <div class="form-group">
                  <input id="pseudo" type="text" class="form-control" placeholder="Pseudo">
               </div>
               <p>Image de profil</p>
               <center>
                  <img id="img_avatar" style="height:6em" src="">
                  <br>
                  <a href="#" onclick="change_avatar()">Nouvelle image</a>
               </center>
            </div>
            <div class="modal-footer">
               <button type="button"  onclick="login()" class="btn btn-primary">Se Connecter</button>
            </div>
         </div>
      </div>
   </div>

   <div class="modal fade" id="version_modal"  data-backdrop="static" tabindex="-1"  aria-hidden="true">
    <div class="modal-dialog">
       <div class="modal-content">
          <div class="modal-header" style="text-align:center">
             <h5 class="modal-title" >AxTi</h5>
          </div>
          <div class="modal-body">
             
             <p id="version_modal_p"></p>

       </div>
    </div>
 </div>
      <script>
/// Variable ///
var socket = io(); //init socket.io
var current_avatar_url; //var for avatar
var Session_id = makeid(5) //unique session id
var userlist = [] //user list
var keep_alive; //interval keepalive.
var state = 0;

/// Function ///

//pass HTML character (ex: <>'")
function escapeHtml(unsafe) {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

//Function for random ID
function makeid(length) {
    var result = '';
    var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    var charactersLength = characters.length;
    for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
    }
    return result;
}

//Hisotry sync
socket.on('sync_message', function(chat_history) {
    console.log(chat_history)
    if (chat_history != undefined) {
        chat_history.forEach(element => add_message(JSON.parse(element).user, JSON.parse(element).img, JSON.parse(element).data));
    }
})

//Keep-alive loop
function keep_alive_inter() {
    keep_alive = setInterval(function() {
        if(socket.disconnected == true){
            $("#version_modal").modal("show")
            state = 1;
            $("#version_modal_p").text("Vous avez été déconnecté(e)")

        }
        if(socket.connected == true){
            $("#version_modal_p").html("une nouvelle version du serveur est disponnible <br> <a href='javascript:location.reload(true)'>Actualiser</a>")

            
        }
        if(state == 0 && socket.disconnected == false){
        socket.emit('keep_alive', JSON.stringify({
            session: Session_id,
            timestamp: Date.now()
        }));
    }
    }, 1000)
}

//add user to userlist
function add_user(id, name, img) {
    $(".userlist").append(`
<div class="card user_card" id="` + id + `">
<div class="card-body">
<img class="avatar_image" src="` + img + `"> <span class="avatar_text">` + name + `</span>
</div>
</div>`)
}

//retrive user from server
socket.on('sync_user', function(msg) {
    console.log(msg)
    if ($("#" + JSON.parse(msg).session).length) {} else {
        add_user(JSON.parse(msg).session, JSON.parse(msg).user, JSON.parse(msg).img)
    }
});

//remove user on userlist
socket.on('on_disconnect', function(msg) {
    console.log(msg)
    $("#" + JSON.parse(msg).session).remove()
});

//Get message
socket.on('chat message', function(msg) {
    console.log(JSON.parse(msg).user)
    add_message(JSON.parse(msg).user, JSON.parse(msg).img, JSON.parse(msg).data)
});

//check if enterkey is pressed on input bar
function checkenter(event) {
    if (event.key == "Enter") {
        socket.emit('chat message', JSON.stringify({
            user: getCookie('username'),
            img: getCookie('img'),
            data: escapeHtml($('#m').val())
        }));

        $('#m').val("")
    }

}

//generation html for messagee
function add_message(username, img, data) {
    $(".message_container").append(`
<div class="card message_card">
<div class="card-body">
<img class="avatar_image" src="` + img + `"> <span class="avatar_text">` + username + `</span> <br>
<p style="margin-left: 0.5em;">` + data + `</p>
<hr style="background-color:#FFF">  
</div>
</div>`)
    $(".message_container").scrollTop($(".message_container")[0].scrollHeight);
    $("#m").focus();

}


//login in axti
function login() {
    setCookie('username', $("#pseudo").val())
    setCookie('img', current_avatar_url)
    $("#loginmodal").modal("hide");
    $("#pseudo_text").text($("#pseudo").val() + " - ")
    keep_alive_inter()
    socket.emit('sync_user', JSON.stringify({
        user: getCookie('username'),
        img: getCookie('img'),
        session: Session_id
    }));
}

//logout 
function logout() {
    setCookie('username', '')
    setCookie('img', '')
    current_avatar_url = ''
    $("#pseudo_text").text("")
    checkCookie()
    clearInterval(keep_alive);
}

//change/set avatar
function change_avatar() {
    current_avatar_url = 'https://api.adorable.io/avatars/285/' + makeid(10)
    $("#img_avatar").attr("src", current_avatar_url)
}

//Set Cookie in client browser
function setCookie(cname, cvalue, exdays) {
    var d = new Date();
    d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
    var expires = "expires=" + d.toUTCString();
    document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
}

//get cookie in client browser
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

//check if user have account in client browser
function checkCookie() {
    var username = getCookie("username");
    if (username != "") {
        $("#pseudo_text").text(username + " - ")
        keep_alive_inter()
        $("#m").focus();

        socket.emit('sync_user', JSON.stringify({
            user: getCookie('username'),
            img: getCookie('img'),
            session: Session_id
        }));
    } else {
        change_avatar()
        clearInterval(keep_alive);
        $("#loginmodal").modal("show");
    }
}

//Set settings for login modal.
$('#loginmodal').modal({
    keyboard: false,
    backdrop: 'static',
})
$('#version_modal').modal({
    keyboard: false,
    backdrop: 'static',
})
</script>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  </body>
</html>